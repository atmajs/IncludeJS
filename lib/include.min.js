(function(global,document){"use strict";var cfg={},bin={},isWeb=!!(global.location&&global.location.protocol&&/^https?:/.test(global.location.protocol)),handler={},regexpName=/\{name\}/g,hasOwnProp={}.hasOwnProperty,rewrites=typeof IncludeRewrites!="undefined"?IncludeRewrites:null,currentParent=null,__eval=function(source,include){return source||console.error("error",include),eval(source)},Helper={uri:{getDir:function(e){var t=e.lastIndexOf("/");return t==-1?"":e.substring(t+1,-t)},resolveCurrent:function(){var e=document.querySelectorAll("script");return e[e.length-1].getAttribute("src")},resolveUrl:function(e,t){cfg.path&&e[0]=="/"&&(e=cfg.path+e.substring(1));if(e[0]=="/")return isWeb===!1||cfg.lockedToFolder===!0?e.substring(1):e;switch(e.substring(0,4)){case"file":case"http":return e}return t!=null&&t.location!=null?t.location+e:e}},extend:function(e,t){for(var n in t)e[n]=t[n];return e},eachIncludeItem:function(e,t,n,r,i){var s;if(t==null){console.error("Include Item has no Data",e,r);return}if(e=="lazy"&&i==null){for(s in t)this.eachIncludeItem(e,t[s],n,null,s);return}if(t instanceof Array){for(var o=0;o<t.length;o++)this.eachIncludeItem(e,t[o],n,r,i);return}if(typeof t=="object"){for(s in t)this.eachIncludeItem(e,t[s],n,s,i);return}if(typeof t=="string"){var u=r&&cfg[r];u&&(r+="."+t,t=u.replace(regexpName,t)),n(r,t,i);return}console.error("Include Package is invalid",arguments)},invokeEach:function(e,t){if(e==null)return;if(e instanceof Array)for(var n=0,r,i=e.length;n<i;n++)r=e[n],typeof r=="function"&&(t!=null?r.apply(this,t):r())},doNothing:function(e){typeof e=="function"&&e()},reportError:function(e){console.error("IncludeJS Error:",e,e.message,e.url),typeof handler.onerror=="function"&&handler.onerror(e)},ensureArray:function(e,t){if(!t)return e;var n=t.split(".");while(n.length-1){var r=n.shift();e=e[r]||(e[r]={})}return e[n.shift()]=[]},xhr:function(e,t){var n=new XMLHttpRequest,r=Date.now();n.onreadystatechange=function(){n.readyState==4&&t&&t(e,n.responseText)},n.open("GET",e,!0),n.send()}},Events=function(e){if(e==null)return{ready:Helper.doNothing,load:Helper.doNothing};var t=[],n=null,r=null,i=Date.now();return e.onreadystatechange=function(){if(/complete|interactive/g.test(e.readyState)===!1)return;i&&console.log("DOMContentLoader",e.readyState,Date.now()-i,"ms"),Events.ready=Events.readyQueue=Helper.doNothing,Helper.invokeEach(r),Helper.invokeEach(t),t=null,r=null,e.readyState=="complete"&&(Events.load=Helper.doNothing,Helper.invokeEach(n),n=null)},{ready:function(e){t.unshift(e)},readyQueue:function(e){(r||(r=[])).push(e)},load:function(e){(n||(n=[])).unshift(e)}}}(document),IncludeDeferred=Class({Construct:function(){this.callbacks=[]},on:function(e,t){return e<=this.state?t(this):this.callbacks.unshift({state:e,callback:t}),this},readystatechanged:function(e){this.state=e;for(var t=0,n,r=this.callbacks.length;t<r;t++){n=this.callbacks[t];if(n.state>this.state||n.callback==null)continue;n.callback(this),n.callback=null}},ready:function(e){return this.on(4,function(){Events.ready(this.resolve.bind(this,e))}.bind(this))},loaded:function(e){return this.on(4,function(){Events.load(e)})},done:function(e){return this.on(4,this.resolve.bind(this,e))},resolve:function(e){var t=e(this.response);t!=null&&(this.obj=t)}}),Include=Class({setCurrent:function(e){currentParent=e},incl:function(e,t){if(this instanceof Resource)return this.include(e,t);var n=new Resource;return currentParent&&(n.id=currentParent.id,n.url=currentParent.url,n.namespace=currentParent.namespace,n.location=Helper.uri.getDir(n.url)),n.include(e,t)},js:function(e){return this.incl("js",e)},css:function(e){return this.incl("css",e)},load:function(e){return this.incl("load",e)},ajax:function(e){return this.incl("ajax",e)},embed:function(e){return this.incl("embed",e)},lazy:function(e){return this.incl("lazy",e)},cfg:function(e){switch(typeof e){case"object":for(var t in e)cfg[t]=e[t];break;case"string":if(arguments.length==1)return cfg[e];arguments.length==2&&(cfg[e]=arguments[1]);break;case"undefined":return cfg}return this},promise:function(e){var t=e.split("."),n=global;while(t.length){var r=t.shift();n=n[r]||(n[r]={})}return n},register:function(e){for(var t in e)for(var n=0;n<e[t].length;n++){var r=e[t][n].id,i=e[t][n].url,s=e[t][n].namespace,o=new Resource;o.state=4,o.namespace=s,o.type=t,i&&(i[0]=="/"&&(i=i.substring(1)),o.location=Helper.uri.getDir(i));switch(t){case"load":case"lazy":var u=document.querySelector('script[data-id="'+r+'"]');if(u==null){console.error('"%s" Data was not embedded into html',r);return}o.obj=u.innerHTML}(bin[t]||(bin[t]={}))[r]=o}}}),loadScript=function(e,t){var n=document.createElement("script");n.type="application/javascript",n.src=e,n.onload=t,n.onerror=t,document.querySelector("head").appendChild(n)},isEvalEnabled=!0,ScriptStack=new(Class({Construct:function(){this.stack=[]},load:function(e,t){var n=this,r=!1;if(t)for(var i=0,s,o=this.stack.length;i<o;i++){s=this.stack[i];if(s==t){this.stack.splice(i,0,e),r=!0;break}}r||this.stack.push(e),isEvalEnabled?Helper.xhr(e.url,function(t,r){r||console.error("no resp",e),e.source=r,e.readystatechanged(3),n.process()}):this.loadByEmbedding()},loadByEmbedding:function(){if(this.stack.length==0){console.log("GG",global.include.url);return}var e=this.stack[0];if(e.state==1)return;e.state=1,global.include=e,loadScript(e.url,function(t){for(var n=0,r,i=this.stack.length;n<i;n++){r=this.stack[n];if(r==e){this.stack.splice(n,1);break}}e.state=3,e.onload(e.url," "),this.loadByEmbedding()}.bind(this))},process:function(){var e=this.stack[0];if(e&&e.state>2){e.state=0;try{__eval(e.source,e)}catch(t){t.url=e.url,Helper.reportError(t)}for(var n=0,r,i=this.stack.length;n<i;n++){r=this.stack[n];if(r==e){this.stack.splice(n,1);break}}e.state=3,e.onload(e.url,e.source),this.process()}}})),Resource=Class({Base:Include,Extends:IncludeDeferred,Construct:function(e,t,n,r,i,s){if(e==null)return this;this.namespace=n,this.type=e,this.xpath=r,this.url=t,t!=null&&(this.url=Helper.uri.resolveUrl(t,i)),s||(n?s=n:t[0]=="/"?s=t:i&&i.namespace?s=i.namespace+"/"+t:i&&i.location?s="/"+i.location.replace(/^[\/]+/,"")+t:i&&i.id?s=i.id+"/"+t:s="/"+t);if(bin[e]&&bin[e][s])return bin[e][s];window.bin=bin,rewrites!=null&&rewrites[s]!=null?t=rewrites[s]:t=this.url,this.location=Helper.uri.getDir(t),(bin[e]||(bin[e]={}))[s]=this;var o;switch(e){case"js":ScriptStack.load(this,i),document!=null;break;case"ajax":case"load":case"lazy":Helper.xhr(t,this.onload.bind(this));break;case"css":this.state=4,o=document.createElement("link"),o.href=t,o.rel="stylesheet",o.type="text/css";break;case"embed":o=document.createElement("script"),o.type="application/javascript",o.src=t,o.onload=function(){this.readystatechanged(4)}.bind(this),o.onerror=o.onload}return o!=null&&(document.querySelector("head").appendChild(o),o=null),this},include:function(e,t){return this.state=0,this.includes==null&&(this.includes=[]),Helper.eachIncludeItem(e,t,function(t,n,r){var i=new Resource(e,n,t,r,this);this.includes.push(i),i.index=this.calcIndex(e,t),i.on(4,this.resourceLoaded.bind(this))}.bind(this)),this},calcIndex:function(e,t){this.response==null&&(this.response={});switch(e){case"js":case"load":case"ajax":return this.response[e+"Index"]==null&&(this.response[e+"Index"]=-1),++this.response[e+"Index"]}return-1},wait:function(){return this},resourceLoaded:function(e){if(e!=null&&e.obj!=null&&e.obj instanceof Include==0)switch(e.type){case"js":case"load":case"ajax":this.response==null&&(this.response={});var t=this.response[e.type]||(this.response[e.type]=[]);e.namespace!=null&&(t=Helper.ensureArray(t,e.namespace)),t[e.index]=e.obj}if(this.includes!=null&&this.includes.length)for(var n=0;n<this.includes.length;n++)if(this.includes[n].state!=4)return;this.readystatechanged(this.state=4)},onload:function(e,t){if(!t){console.warn("Resource cannt be loaded",this.url),this.readystatechanged(4);return}switch(this.type){case"load":case"ajax":this.obj=t;break;case"lazy":LazyModule.create(this.xpath,t);break;case"js":}this.resourceLoaded(this)}}),LazyModule={create:function(e,t){var n=e.split("."),r=global,i=n[n.length-1];while(n.length>1){var s=n.shift();r=r[s]||(r[s]={})}n=null,Object.defineProperty(r,i,{get:function(){delete r[i];try{var n=__eval(t,global.include);n!=null&&n instanceof Resource==0&&(r[i]=n)}catch(s){s.xpath=e,Helper.reportError(s)}finally{return t=null,e=null,r[i]}}})}};global.include=new Include,global.include.helper=Helper,global.IncludeResource=Resource})(this,document);